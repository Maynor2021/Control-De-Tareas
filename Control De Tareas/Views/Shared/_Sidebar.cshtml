
@using Newtonsoft.Json
@using Control_De_Tareas.Models


@{
    UserVm usuarioObjeto = null;
    
    // Leer sesión del usuario
    var sesionBase64 = Context.Session.GetString("UserSession");
    
    if (!string.IsNullOrEmpty(sesionBase64))
    {
        try
        {
            var base64EncodedBytes = System.Convert.FromBase64String(sesionBase64);
            var sesion = System.Text.Encoding.UTF8.GetString(base64EncodedBytes);
            usuarioObjeto = JsonConvert.DeserializeObject<UserVm>(sesion);
        }
        catch (Exception ex)
        {
            // Log error si es necesario
            usuarioObjeto = null;
        }
    }

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
}

@if (usuarioObjeto != null && usuarioObjeto.menu != null && usuarioObjeto.menu.Any())
{
    <aside class="sidebar" id="dynamicSidebar">
        <div class="sidebar-header p-3 border-bottom">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                    <div class="menu-text">
                        <strong>@usuarioObjeto.Nombre</strong>
                        <br />
                        <small class="text-muted">@usuarioObjeto.Rol?.Nombre</small>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-list"></i>
                </button>
            </div>
        </div>

        <nav class="p-3">
            <ul class="nav flex-column">
                @foreach (var menu in usuarioObjeto.menu)
                {
                    bool tiene_submenu = menu.Modulos != null && menu.Modulos.Count > 1;
                    string claseMenu = tiene_submenu ? "nav-item dropdown" : "nav-item";

                    <li class="@claseMenu mb-2">
                        @if (tiene_submenu)
                        {
                            <!-- Menú con dropdown (múltiples módulos) -->
                            <a class="nav-link dropdown-toggle d-flex align-items-center text-dark" 
                               href="#" 
                               id="navbarDropdown@(menu.GroupModuleId)" 
                               role="button" 
                               data-bs-toggle="dropdown" 
                               aria-expanded="false"
                               style="padding: 0.75rem 1rem;">
                                <i class="bi bi-folder me-2"></i>
                                <span class="menu-text">@menu.Descripcion</span>
                            </a>
                            
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown@(menu.GroupModuleId)">
                                @foreach (var submenu in menu.Modulos)
                                {
                                    var isActiveSubmenu = submenu.Controlador == currentController && submenu.Metodo == currentAction;
                                    
                                    <li>
                                        <a class="dropdown-item @(isActiveSubmenu ? "active" : "")" 
                                           asp-area="" 
                                           asp-controller="@submenu.Controlador" 
                                           asp-action="@submenu.Metodo">
                                            <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>
                                            @submenu.Nombre
                                        </a>
                                    </li>
                                }
                            </ul>
                        }
                        else if (menu.Modulos != null && menu.Modulos.Count == 1)
                        {
                            <!-- Menú simple (un solo módulo) -->
                            var modulo = menu.Modulos.First();
                            var isActive = modulo.Controlador == currentController && modulo.Metodo == currentAction;
                            
                            <a asp-controller="@modulo.Controlador" 
                               asp-action="@modulo.Metodo"
                               class="nav-link d-flex align-items-center text-dark @(isActive ? "active" : "")"
                               style="padding: 0.75rem 1rem; border-left: 3px solid transparent; @(isActive ? "border-left-color: #0d6efd; background-color: rgba(13, 110, 253, 0.1);" : "")">
                                <i class="bi bi-circle me-2"></i>
                                <span class="menu-text">@menu.Descripcion</span>
                            </a>
                        }
                    </li>
                }

              
            </ul>
        </nav>
    </aside>
}
else
{
    <!-- Sidebar para usuario no autenticado -->
    <aside class="sidebar" id="dynamicSidebar">
        <div class="p-3 text-center">
            <p class="text-muted">No hay sesión activa</p>
            <a asp-controller="Account" asp-action="Login" class="btn btn-primary btn-sm">Iniciar Sesión</a>
        </div>
    </aside>
}

<style>
    .sidebar {
        width: 260px;
        transition: width 0.3s ease;
        position: fixed;
        height: calc(100vh - 56px);
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 1000;
        top: 56px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .sidebar.collapsed {
        width: 70px;
    }

    .sidebar.collapsed .menu-text {
        display: none;
    }

    .sidebar.collapsed .sidebar-header .menu-text {
        display: none;
    }

    .sidebar-header {
        background-color: white;
    }

    .nav-link {
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-bottom: 4px;
    }

    .nav-link:hover {
        background-color: rgba(13, 110, 253, 0.08) !important;
        transform: translateX(3px);
    }

    .nav-link.active {
        background-color: rgba(13, 110, 253, 0.15) !important;
        border-left-color: #0d6efd !important;
        font-weight: 600;
    }

    .dropdown-menu {
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        margin-top: 8px;
    }

    .dropdown-item {
        padding: 0.6rem 1rem;
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: rgba(13, 110, 253, 0.08);
        transform: translateX(5px);
    }

    .dropdown-item.active {
        background-color: #0d6efd;
        color: white;
    }

    /* Scrollbar personalizado */
    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
</style>

<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('dynamicSidebar');
        const mainContent = document.querySelector('main[role="main"]');

        if (sidebar && mainContent) {
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                mainContent.style.marginLeft = '70px';
                mainContent.style.width = 'calc(100% - 70px)';
            } else {
                mainContent.style.marginLeft = '260px';
                mainContent.style.width = 'calc(100% - 260px)';
            }
        }
    }

    // Cerrar dropdowns al hacer clic fuera
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('.dropdown-menu.show');
        dropdowns.forEach(dropdown => {
            if (!dropdown.previousElementSibling.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    });
</script>

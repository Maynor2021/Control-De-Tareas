@using Newtonsoft.Json
@using Control_De_Tareas.Models
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
@using Control_De_Tareas.Services

@{
    // Diccionario de iconos por controlador/acción
    var iconos = new Dictionary<string, string>
    {
        { "Dashboard/Index", "speedometer2" },
        { "Cursos/Index", "book" },
        { "Tareas/Index", "clipboard-check" },
        { "Grade/Index", "trophy" },
        { "Anuncios/Index", "megaphone" },
        { "Entregas/Index", "upload" },
        { "Grades/Index", "bar-chart" },
        { "Usuarios/Index", "people" },
        { "Audit/Index", "file-text" }
    };
}

@{
    UserVm usuarioObjeto = null;

    // Leer sesión del usuario
    var sesionBase64 = Context.Session.GetString("UserSession");

    if (!string.IsNullOrEmpty(sesionBase64))
    {
        try
        {
            var base64EncodedBytes = System.Convert.FromBase64String(sesionBase64);
            var sesion = System.Text.Encoding.UTF8.GetString(base64EncodedBytes);
            usuarioObjeto = JsonConvert.DeserializeObject<UserVm>(sesion);
        }
        catch (Exception ex)
        {
            // Log error si es necesario
            usuarioObjeto = null;
        }
    }

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
}

@if (usuarioObjeto != null && usuarioObjeto.menu != null && usuarioObjeto.menu.Any())
{
    <aside class="sidebar" id="dynamicSidebar">
        <div class="sidebar-header p-3 border-bottom">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle me-2" style="font-size: 2rem; color: #0d6efd;"></i>
                    <div class="menu-text">
                        <strong>@usuarioObjeto.Nombre</strong>
                        <br />
                        <small class="text-muted">@usuarioObjeto.Rol?.Nombre</small>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-list"></i>
                </button>
            </div>
        </div>

        <nav class="p-3">
            <ul class="nav flex-column">
                @foreach (var menu in usuarioObjeto.menu)
                {
                    bool tiene_submenu = menu.Modulos != null && menu.Modulos.Count > 1;

                    if (tiene_submenu)
                    {
                        <!-- Menú con dropdown (múltiples módulos) -->
                        <li class="nav-item mb-2">
                            <a class="nav-link dropdown-toggle d-flex align-items-center text-dark"
                               href="#submenu@(menu.GroupModuleId)"
                               data-bs-toggle="collapse"
                               aria-expanded="false"
                               style="padding: 0.75rem 1rem; cursor: pointer;">
                                @{
                                    // Obtener el primer módulo para el icono del grupo
                                    var primerModulo = menu.Modulos.First();
                                    var claveGrupo = $"{primerModulo.Controlador}/{primerModulo.Metodo}";
                                    var iconoGrupo = iconos.ContainsKey(claveGrupo) ? iconos[claveGrupo] : "folder";
                                }
                                <i class="bi bi-@iconoGrupo me-2" style="font-size: 1.1rem;"></i>
                                <span class="menu-text">@menu.Descripcion</span>
                            </a>

                            <div class="collapse" id="submenu@(menu.GroupModuleId)">
                                <ul class="submenu-list">
                                    @foreach (var submenu in menu.Modulos)
                                    {
                                        var isActiveSubmenu = submenu.Controlador == currentController && submenu.Metodo == currentAction;
                                        var clave = $"{submenu.Controlador}/{submenu.Metodo}";
                                        var icono = iconos.ContainsKey(clave) ? iconos[clave] : "circle";

                                        <li>
                                            <a class="submenu-item @(isActiveSubmenu ? "active" : "")"
                                               asp-area=""
                                               asp-controller="@submenu.Controlador"
                                               asp-action="@submenu.Metodo">
                                                <i class="bi bi-@icono me-2" style="font-size: 0.95rem;"></i>
                                                <span class="menu-text">@submenu.Nombre</span>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </li>
                    }
                    else if (menu.Modulos != null && menu.Modulos.Count == 1)
                    {
                        <!-- Menú simple (un solo módulo) -->
                        var modulo = menu.Modulos.First();
                        var isActive = modulo.Controlador == currentController && modulo.Metodo == currentAction;
                        var clave = $"{modulo.Controlador}/{modulo.Metodo}";
                        var icono = iconos.ContainsKey(clave) ? iconos[clave] : "circle";

                        <li class="nav-item mb-2">
                            <a asp-controller="@modulo.Controlador"
                               asp-action="@modulo.Metodo"
                               class="nav-link d-flex align-items-center text-dark @(isActive ? "active" : "")"
                               style="padding: 0.75rem 1rem; border-left: 3px solid transparent; border-radius: 8px; @(isActive ? "border-left-color: #0d6efd; background-color: rgba(13, 110, 253, 0.1); font-weight: 500;" : "")">
                                <i class="bi bi-@icono me-2" style="font-size: 1.1rem;"></i>
                                <span class="menu-text">@menu.Descripcion</span>
                            </a>
                        </li>
                    }
                }
            </ul>
        </nav>
    </aside>
}
else
{
    <!-- Sidebar para usuario no autenticado -->
    <aside class="sidebar" id="dynamicSidebar">
        <div class="p-3 text-center">
            <p class="text-muted">No hay sesión activa</p>
            <a asp-controller="Account" asp-action="Login" class="btn btn-primary btn-sm">Iniciar Sesión</a>
        </div>
    </aside>
}

<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('dynamicSidebar');
        const mainContent = document.querySelector('main[role="main"]');

        if (sidebar && mainContent) {
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                mainContent.style.marginLeft = '70px';
                mainContent.style.width = 'calc(100% - 70px)';
            } else {
                mainContent.style.marginLeft = '260px';
                mainContent.style.width = 'calc(100% - 260px)';
            }
        }
    }
</script>

<style>
    /* Estilos para el submenu */
    .submenu-list {
        list-style: none;
        padding: 0;
        margin: 0;
        padding-left: 1rem;
    }

    .submenu-item {
        display: flex;
        align-items: center;
        padding: 0.65rem 1rem;
        margin: 0.25rem 0;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        transition: all 0.2s ease;
        border-left: 2px solid transparent;
    }

        .submenu-item:hover {
            background-color: rgba(13, 110, 253, 0.08);
            color: #0d6efd;
            border-left-color: #0d6efd;
            transform: translateX(3px);
        }

        .submenu-item.active {
            background-color: rgba(13, 110, 253, 0.15);
            color: #0d6efd;
            border-left-color: #0d6efd;
            font-weight: 500;
        }

        .submenu-item i {
            color: inherit;
        }

    /* Animación del dropdown toggle */
    .nav-link.dropdown-toggle::after {
        transition: transform 0.3s ease;
    }

    .nav-link.dropdown-toggle[aria-expanded="true"]::after {
        transform: rotate(180deg);
    }

    /* Hover del nav-link principal */
    .nav-link:hover {
        background-color: rgba(13, 110, 253, 0.05);
        border-radius: 8px;
    }

    /* Collapsed sidebar - esconder texto de submenú */
    .sidebar.collapsed .submenu-list {
        display: none;
    }
</style>